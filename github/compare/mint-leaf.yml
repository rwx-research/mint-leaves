name: github/compare
version: 1.0.0
description: Compare two git refs in GitHub and check if certain files changed
source_code_url: https://github.com/rwx-research/mint-leaves/tree/main/github/compare
issue_tracker_url: https://github.com/rwx-research/mint-leaves/issues

parameters:
  repository:
    description: The owner/repository-name of your GitHub repository (e.g. `my-organization/my-repository`)
    required: true
  base-ref:
    description: "The git ref to compare `head-ref` against"
    required: true
  head-ref:
    description: "The git ref to compare against `base-ref`"
    required: true
  github-token:
    description: "A GitHub token with read access to the repository. Usually `${{ github.token }}`."
    required: false
  patterns:
    description: "A newline-separated list of glob patterns to match against the changed files"
    required: false

outputs:
  values-from: [compare]

tasks:
  - key: compare
    run: |
      gh api /repos/${REPOSITORY}/compare/${BASE_REF}...${HEAD_REF} > compare.json

      jq -r '.files[].filename' < compare.json > files.txt
      echo "All changed files:"
      cat files.txt

      cat files.txt | $MINT_LEAF_PATH/bin/glob_patterns "$PATTERNS" > matches.txt
      echo
      echo "All matched files:"
      cat matches.txt

      contents=$(cat matches.txt)
      if [ "${contents}" == "" ]; then
        echo "false" > $MINT_VALUES/matches
      else
        echo "true" > $MINT_VALUES/matches
      fi
    env:
      BASE_REF: ${{ params.base-ref }}
      HEAD_REF: ${{ params.head-ref }}
      REPOSITORY: ${{ params.repository }}
      GITHUB_TOKEN: ${{ params.github-token }}
      PATTERNS: ${{ params.patterns }}
