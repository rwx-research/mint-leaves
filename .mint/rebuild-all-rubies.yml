tasks:
  - key: versions
    run: |
      jq -cn \
        --arg version "$RUBY_VERSION" \
        --arg os "$BASE_OS" \
        --arg tag "$BASE_TAG" \
        --arg arch "$BASE_ARCH" \
        '{"ruby-version": $version, "os": $os, "tag": $tag, "arch": $arch}' | tee "ruby-$RUBY_VERSION-$BASE_OS-${BASE_TAG}-${BASE_ARCH}.json"
    env:
      RUBY_VERSION: ${{ parallel.ruby-version }}
      BASE_OS: ${{ parallel.os }}
      BASE_TAG: ${{ parallel.tag }}
      BASE_ARCH: ${{ parallel.arch }}
    parallel:
      tasks-limit: 100
      key: ruby-${{ parallel.ruby-version }}-${{ parallel.os }}-${{ parallel.tag }}-${{ parallel.arch }}
      values:
        # tail -n +2 mint/install-ruby/known-rubies.csv | cut -f1 -d, | sort -V | uniq | sed -e 's/^/        - ruby-version: /'
        - ruby-version: 3.0.3
          os: ubuntu 22.04
          tag: '1.0'
          arch: x86_64
        - ruby-version: 3.0.3
          os: ubuntu 24.04
          tag: '1.0'
          arch: x86_64
        - ruby-version: 3.0.4
          os: ubuntu 22.04
          tag: '1.0'
          arch: x86_64
        - ruby-version: 3.0.4
          os: ubuntu 24.04
          tag: '1.0'
          arch: x86_64
        - ruby-version: 3.0.5
          os: ubuntu 22.04
          tag: '1.0'
          arch: x86_64
        - ruby-version: 3.0.5
          os: ubuntu 24.04
          tag: '1.0'
          arch: x86_64
        - ruby-version: 3.0.6
          os: ubuntu 22.04
          tag: '1.0'
          arch: x86_64
        - ruby-version: 3.0.6
          os: ubuntu 24.04
          tag: '1.0'
          arch: x86_64
        - ruby-version: 3.0.7
          os: ubuntu 22.04
          tag: '1.0'
          arch: x86_64
        - ruby-version: 3.0.7
          os: ubuntu 24.04
          tag: '1.0'
          arch: x86_64
        - ruby-version: 3.1.0
          os: ubuntu 22.04
          tag: '1.0'
          arch: x86_64
        - ruby-version: 3.1.0
          os: ubuntu 24.04
          tag: '1.0'
          arch: x86_64
        - ruby-version: 3.1.1
          os: ubuntu 22.04
          tag: '1.0'
          arch: x86_64
        - ruby-version: 3.1.1
          os: ubuntu 24.04
          tag: '1.0'
          arch: x86_64
        - ruby-version: 3.1.2
          os: ubuntu 22.04
          tag: '1.0'
          arch: x86_64
        - ruby-version: 3.1.2
          os: ubuntu 24.04
          tag: '1.0'
          arch: x86_64
        - ruby-version: 3.1.3
          os: ubuntu 22.04
          tag: '1.0'
          arch: x86_64
        - ruby-version: 3.1.3
          os: ubuntu 24.04
          tag: '1.0'
          arch: x86_64
        - ruby-version: 3.1.4
          os: ubuntu 22.04
          tag: '1.0'
          arch: x86_64
        - ruby-version: 3.1.4
          os: ubuntu 24.04
          tag: '1.0'
          arch: x86_64
        - ruby-version: 3.1.5
          os: ubuntu 22.04
          tag: '1.0'
          arch: x86_64
        - ruby-version: 3.1.5
          os: ubuntu 24.04
          tag: '1.0'
          arch: x86_64
        - ruby-version: 3.1.6
          os: ubuntu 22.04
          tag: '1.0'
          arch: x86_64
        - ruby-version: 3.1.6
          os: ubuntu 24.04
          tag: '1.0'
          arch: x86_64
        - ruby-version: 3.1.7
          os: ubuntu 22.04
          tag: '1.0'
          arch: x86_64
        - ruby-version: 3.1.7
          os: ubuntu 24.04
          tag: '1.0'
          arch: x86_64
        - ruby-version: 3.2.0
          os: ubuntu 22.04
          tag: '1.0'
          arch: x86_64
        - ruby-version: 3.2.0
          os: ubuntu 24.04
          tag: '1.0'
          arch: x86_64
        - ruby-version: 3.2.1
          os: ubuntu 22.04
          tag: '1.0'
          arch: x86_64
        - ruby-version: 3.2.1
          os: ubuntu 24.04
          tag: '1.0'
          arch: x86_64
        - ruby-version: 3.2.2
          os: ubuntu 22.04
          tag: '1.0'
          arch: x86_64
        - ruby-version: 3.2.2
          os: ubuntu 24.04
          tag: '1.0'
          arch: x86_64
        - ruby-version: 3.2.3
          os: ubuntu 22.04
          tag: '1.0'
          arch: x86_64
        - ruby-version: 3.2.3
          os: ubuntu 24.04
          tag: '1.0'
          arch: x86_64
        - ruby-version: 3.2.4
          os: ubuntu 22.04
          tag: '1.0'
          arch: x86_64
        - ruby-version: 3.2.4
          os: ubuntu 24.04
          tag: '1.0'
          arch: x86_64
        - ruby-version: 3.2.5
          os: ubuntu 22.04
          tag: '1.0'
          arch: x86_64
        - ruby-version: 3.2.5
          os: ubuntu 24.04
          tag: '1.0'
          arch: x86_64
        - ruby-version: 3.2.6
          os: ubuntu 22.04
          tag: '1.0'
          arch: x86_64
        - ruby-version: 3.2.6
          os: ubuntu 24.04
          tag: '1.0'
          arch: x86_64
        - ruby-version: 3.2.7
          os: ubuntu 22.04
          tag: '1.0'
          arch: x86_64
        - ruby-version: 3.2.7
          os: ubuntu 24.04
          tag: '1.0'
          arch: x86_64
        - ruby-version: 3.2.8
          os: ubuntu 22.04
          tag: '1.0'
          arch: x86_64
        - ruby-version: 3.2.8
          os: ubuntu 24.04
          tag: '1.0'
          arch: x86_64
        - ruby-version: 3.3.0
          os: ubuntu 22.04
          tag: '1.0'
          arch: x86_64
        - ruby-version: 3.3.0
          os: ubuntu 24.04
          tag: '1.0'
          arch: x86_64
        - ruby-version: 3.3.1
          os: ubuntu 22.04
          tag: '1.0'
          arch: x86_64
        - ruby-version: 3.3.1
          os: ubuntu 24.04
          tag: '1.0'
          arch: x86_64
        - ruby-version: 3.3.2
          os: ubuntu 22.04
          tag: '1.0'
          arch: x86_64
        - ruby-version: 3.3.2
          os: ubuntu 24.04
          tag: '1.0'
          arch: x86_64
        - ruby-version: 3.3.3
          os: ubuntu 22.04
          tag: '1.0'
          arch: x86_64
        - ruby-version: 3.3.3
          os: ubuntu 24.04
          tag: '1.0'
          arch: x86_64
        - ruby-version: 3.3.4
          os: ubuntu 22.04
          tag: '1.0'
          arch: x86_64
        - ruby-version: 3.3.4
          os: ubuntu 24.04
          tag: '1.0'
          arch: x86_64
        - ruby-version: 3.3.5
          os: ubuntu 22.04
          tag: '1.0'
          arch: x86_64
        - ruby-version: 3.3.5
          os: ubuntu 24.04
          tag: '1.0'
          arch: x86_64
        - ruby-version: 3.3.6
          os: ubuntu 22.04
          tag: '1.0'
          arch: x86_64
        - ruby-version: 3.3.6
          os: ubuntu 24.04
          tag: '1.0'
          arch: x86_64
        - ruby-version: 3.3.7
          os: ubuntu 22.04
          tag: '1.0'
          arch: x86_64
        - ruby-version: 3.3.7
          os: ubuntu 24.04
          tag: '1.0'
          arch: x86_64
        - ruby-version: 3.4.0
          os: ubuntu 22.04
          tag: '1.0'
          arch: x86_64
        - ruby-version: 3.4.0
          os: ubuntu 24.04
          tag: '1.0'
          arch: x86_64
        - ruby-version: 3.4.1
          os: ubuntu 22.04
          tag: '1.0'
          arch: x86_64
        - ruby-version: 3.4.1
          os: ubuntu 24.04
          tag: '1.0'
          arch: x86_64
        - ruby-version: 3.4.2
          os: ubuntu 22.04
          tag: '1.0'
          arch: x86_64
        - ruby-version: 3.4.2
          os: ubuntu 24.04
          tag: '1.0'
          arch: x86_64
  - key: build-manifest
    use: versions
    run: |
      cat ruby-*.json | tee ruby-versions-manifest.jsonl
      jq -cs '.' ruby-versions-manifest.jsonl > ruby-parallel-manifest.json
      cat ruby-parallel-manifest.json > "$MINT_VALUES/parallel-versions"
    outputs:
      artifacts:
        - key: ruby-versions-manifest
          path: ruby-versions-manifest.jsonl
        - key: ruby-parallel-manifest
          path: ruby-parallel-manifest.json
  - key: build-rubies
    call: ${{ run.mint-dir }}/ruby-binary-builder.yml
    init:
      ruby-version: ${{ parallel.ruby-version }}
      base-os: ${{ parallel.os }}
      base-tag: ${{ parallel.tag }}
      base-arch: ${{ parallel.arch }}
    parallel:
      tasks-limit: 100
      key: ruby-${{ parallel.ruby-version }}-${{ parallel.os }}-${{ parallel.tag }}-${{ parallel.arch }}
      values: ${{ tasks.build-manifest.values.parallel-versions }}
  - key: generate-results
    run: |
      VERSION_KEYS=($(echo '${{ tasks.build-manifest.values.parallel-versions }}' | jq -r '.[] | "\(.["ruby-version"])-\(.os)-\(.tag)-\(.arch)"' | tr -c -s '[:alnum:]\n' '-' | sed 's/x86-64/x86_64/g' ))
      COMMAND=""
      declare -i INDEX=0

      for VERSION_KEY in "${VERSION_KEYS[@]}"
      do
        COMMAND+="
            echo \\\${{ tasks.build-rubies.tasks.ruby-${VERSION_KEY}-${INDEX}.tasks.upload-layer.values.known-ruby }} | tee -a known-rubies.csv"
        INDEX=$((INDEX + 1))
      done

      cat << EOF | tee $MINT_DYNAMIC_TASKS/tasks.yml
        - key: results
          run: |
            touch known-rubies.csv
            $COMMAND
          outputs:
            artifacts:
              - key: known-rubies
                path: known-rubies.csv
      EOF
