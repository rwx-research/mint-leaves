on:
  github:
    pull_request:
      init:
        base-ref: origin/${{ event.github.pull_request.pull_request.base.ref }}
        branch: ${{ event.git.branch }}
        publish-leaves: false
        sha: ${{ event.git.sha }}
    push:
      if: ${{ event.git.branch == 'main' }}
      init:
        base-ref: ${{ event.github.push.before }}
        branch: ${{ event.git.branch }}
        publish-leaves: true
        sha: ${{ event.git.sha }}

concurrency-pools:
  - id: rwx-research/mint-leaves:branch-${{ init.branch }}
    if: ${{ init.branch != 'main' }}
    capacity: 1
    on-overflow: cancel-running

tasks:
  - key: system-packages
    run: |
      sudo apt-get update
      sudo apt-get install gettext-base jq zip
      sudo apt-get clean

  - key: checkout
    call: mint/git-clone 1.5.0
    with:
      preserve-git-dir: true
      repository: https://github.com/rwx-research/mint-leaves.git
      ref: ${{ init.sha }}

  - key: node
    use: checkout
    call: mint/install-node 1.0.11
    with:
      node-version-file: .node-version
    filter:
      - .node-version

  - key: npm-install
    use: node
    run: npm ci
    filter:
      - package.json
      - package-lock.json
      - .node-version

  - key: spellcheck
    use: npm-install
    run: npm run spellcheck

  - key: check-version-consistency
    use: checkout
    run: |
      leaves=$(ls */*/mint-leaf.yml | cut -d/ -f1,2)
      while read -r leaf; do
        echo "Checking $leaf..."
        version=$(grep '^version:' $leaf/mint-leaf.yml | awk '{print $2}')
        echo "$version"
        set +e
        mismatches=$(grep "call: $leaf" $leaf/README.md | grep -v "$version")
        set -e
        if [[ -n "$mismatches" ]]; then
          echo "$mismatches"
          exit 1
        fi
      done <<< "$leaves"
    filter:
      - "**/README.md"
      - "**/mint-leaf.yml"

  - key: build-leaf-runs
    use: npm-install
    run: |
      mkdir build
      git diff --name-only $BASE_REF $SHA > $GIT_DIFF_FILE
      node .mint/build-tasks.mjs
    env:
      BASE_REF: ${{ init.base-ref }}
      BUILD_DIR: build
      GIT_DIFF_FILE: build/git-diff.txt
      SHA: ${{ init.sha }}
