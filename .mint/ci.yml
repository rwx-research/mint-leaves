on:
  github:
    push:
      init:
        branch: ${{ mint.run.git.branch }}
        publishleaves: ${{ mint.run.git.branch == 'main' }}
        sha: ${{ event.github.push.head_commit.id }}

concurrency-pools:
  - id: feature-branch-${{ init.branch }}
    if: ${{ init.branch != 'main' }}
    capacity: 1
    on-overflow: cancel-running

tasks:
  - key: system-packages
    run: |
      sudo apt-get update
      sudo apt-get install gettext-base jq zip
      sudo apt-get clean
  - key: secrets-for-leaf-tests
    run: |
      echo "${{ vaults.mint_leaves_development.secrets.CHECKOUT_LEAF_TEST_SSH_KEY }}" > git-clone-test-ssh-key
      echo "${{ vaults.mint_leaves_development.secrets.RWX_ACCESS_TOKEN_PRODUCTION_MINT_ORG }}" > build-leaf-test-rwx-access-token
  - key: checkout
    call: mint/git-clone 1.0.0
    with:
      preserve-git-dir: true
      repository: https://github.com/rwx-research/mint-leaves.git
      ref: ${{ init.sha }}
  - key: node
    use: checkout
    call: mint/install-node 1.0.0
    with:
      node-version-file: .node-version
    filter:
      - .node-version
  - key: npm-install
    use: node
    run: npm install
    filter: [package.json, package-lock.json]
  - key: spellcheck
    use: npm-install
    run: npm run spellcheck
  - key: check-version-consistency
    use: checkout
    run: |
      declare -a leaves=("build-leaf" "git-clone" "install-go" "install-node" "install-ruby")
      for leaf in "${leaves[@]}"; do
        echo "Checking $leaf..."
        version=$(grep '^version:' $leaf/mint-leaf.yml | awk '{print $2}')
        echo "$version"
        set +e
        mismatches=$(grep "call: mint/$leaf" $leaf/README.md | grep -v "$version")
        set -e
        if [[ -n "$mismatches" ]]; then
          echo "$mismatches"
          exit 1
        fi
      done
    filter:
      - "*/README.md"
      - "*/mint-leaf.yml"
  - key: generate-tasks
    use: [system-packages, checkout]
    run: |
      LEAF_NAME=build-leaf envsubst '$LEAF_NAME' < per-leaf-tasks.template.yml > $MINT_DYNAMIC_TASKS/build-leaf.yml
      LEAF_NAME=git-clone envsubst '$LEAF_NAME' < per-leaf-tasks.template.yml > $MINT_DYNAMIC_TASKS/git-clone.yml
      LEAF_NAME=greeting envsubst '$LEAF_NAME' < per-leaf-tasks.template.yml > $MINT_DYNAMIC_TASKS/greeting.yml
      LEAF_NAME=install-go envsubst '$LEAF_NAME' < per-leaf-tasks.template.yml > $MINT_DYNAMIC_TASKS/install-go.yml
      LEAF_NAME=install-node envsubst '$LEAF_NAME' < per-leaf-tasks.template.yml > $MINT_DYNAMIC_TASKS/install-node.yml
      LEAF_NAME=install-ruby envsubst '$LEAF_NAME' < per-leaf-tasks.template.yml > $MINT_DYNAMIC_TASKS/install-ruby.yml
    filter:
      - per-leaf-tasks.template.yml
