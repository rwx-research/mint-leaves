on:
  github:
    push:
      init:
        publishleaves: "true" # #{{ mint.run.git.branch == 'main' }}
        sha: ${{ event.github.push.head_commit.id }}

tasks:
  - key: system-packages
    run: |
      sudo apt-get update
      sudo apt-get install gettext-base jq zip
      sudo apt-get clean
  - key: checkout
    call: mint/checkout
    with:
      repository: https://github.com/rwx-research/mint-leaves.git
      ref: ${{ init.sha }}
  - key: generate-tasks
    use: [system-packages, checkout]
    run: |
      LEAF_NAME=checkout envsubst '$LEAF_NAME' < per-leaf-tasks.template.yml > $MINT_DYNAMIC_TASKS/checkout.yml
      LEAF_NAME=greeting envsubst '$LEAF_NAME' < per-leaf-tasks.template.yml > $MINT_DYNAMIC_TASKS/greeting.yml
      LEAF_NAME=setup-go envsubst '$LEAF_NAME' < per-leaf-tasks.template.yml > $MINT_DYNAMIC_TASKS/setup-go.yml
      LEAF_NAME=setup-node envsubst '$LEAF_NAME' < per-leaf-tasks.template.yml > $MINT_DYNAMIC_TASKS/setup-node.yml
      LEAF_NAME=setup-ruby envsubst '$LEAF_NAME' < per-leaf-tasks.template.yml > $MINT_DYNAMIC_TASKS/setup-ruby.yml
