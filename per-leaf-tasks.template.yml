- key: $LEAF_NAME--build
  use: [system-packages, checkout]
  run: |
    cd $LEAF_NAME && zip -X -r ../$LEAF_NAME.zip .
  filter:
    - $LEAF_NAME/**/*
- key: $LEAF_NAME--upload-staging
  use: $LEAF_NAME--build
  run: |
    curl \
      --request POST \
      --fail-with-body \
      --header "Authorization: Bearer $RWX_ACCESS_TOKEN" \
      --header 'Accept: application/json' \
      -F 'file=@$LEAF_NAME.zip' \
      https://staging.cloud.rwx.com/mint/api/leaves | tee leaves-result.json
      LEAF_DIGEST=$(cat leaves-result.json | jq -r '.digest')
      echo -n "$LEAF_DIGEST" > $MINT_VALUES/leaf-digest
  env:
    RWX_ACCESS_TOKEN: ${{ vaults.mint_leaves_development.secrets.RWX_ACCESS_TOKEN_STAGING_MINT_ORG }}
  filter:
    - $LEAF_NAME.zip
  outputs:
    values:
      - leaf-digest

- key: $LEAF_NAME--upload-production
  use: $LEAF_NAME--build
  run: |
    curl \
      --request POST \
      --fail-with-body \
      --header "Authorization: Bearer $RWX_ACCESS_TOKEN" \
      --header 'Accept: application/json' \
      -F 'file=@$LEAF_NAME.zip' \
      https://cloud.rwx.com/mint/api/leaves | tee leaves-result.json

      export LEAF_DIGEST=$(cat leaves-result.json | jq -r '.digest')
      echo -n "$LEAF_DIGEST" > $MINT_VALUES/leaf-digest

      envsubst '$LEAF_DIGEST' < $LEAF_NAME/mint-ci-cd.template.yml | tee $MINT_DYNAMIC_TASKS/$LEAF_NAME.yml

      export PUBLISH_LEAF_NAME="$LEAF_NAME"
      export LEAF_TEST_TASKS=$(grep ' key: ' $MINT_DYNAMIC_TASKS/$LEAF_NAME-ci-cd.yml | awk '{print $3}' | paste -s -d ',' -)

      envsubst '$PUBLISH_LEAF_NAME,$LEAF_TEST_TASKS' < publish-tasks.template.yml | tee -a $MINT_DYNAMIC_TASKS/$LEAF_NAME.yml
  env:
    RWX_ACCESS_TOKEN: ${{ vaults.mint_leaves_development.secrets.RWX_ACCESS_TOKEN_PRODUCTION_MINT_ORG }}
  filter:
    - $LEAF_NAME.zip
    - $LEAF_NAME/mint-ci-cd.template.yml
    - publish-tasks.template.yml
  outputs:
    values:
      - leaf-digest
